map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  root /srv/www/public_html;
  
  location /rstudio/ {
    rewrite ^/rstudio/(.*)$ /$1 break;
    proxy_pass         http://localhost:8787;
    proxy_redirect     http://$proxy_host $scheme://$http_host/rstudio;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
    proxy_read_timeout 20d;
  }

  location /jupyter/ {
    proxy_pass         http://localhost:8000;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
    proxy_read_timeout 20d;
  }

  location /pgstudio/ {
    proxy_pass         http://localhost:8080/;
    proxy_redirect     http://$proxy_host $scheme://$http_host/pgstudio;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
    proxy_read_timeout 20d;
  }
  
  location /butterfly {
    # see github.com/paradoxxxzero/butterfly/wiki

    rewrite ^/butterfly/?(.*) /$1 break;
    proxy_pass         http://127.0.0.1:57575;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
    proxy_set_header   Host $host;
    proxy_set_header   Origin "$scheme://$host";
    
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;

    sub_filter_once off;
    
    sub_filter_types text/css text/xml application/javascript;
    sub_filter /style.css '/butterfly/style.css';
    sub_filter /static '/butterfly/static';
    sub_filter /ws '/butterfly/ws';
    sub_filter /ctl '/butterfly/ctl';
    sub_filter /themes '/butterfly/themes';
    sub_filter location.pathname '"/"';
    sub_filter /local.js '/butterfly/local.js';
  }

  rewrite ^/theme/?(.*)/butterfly/?(.*) /butterfly/theme/$1/$2 permanent;
}
